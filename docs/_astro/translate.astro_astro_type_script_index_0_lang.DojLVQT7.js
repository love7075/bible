import{b as T,f as S,v as q,a as j}from"./utils.BUDBmIgQ.js";const H={async request(t,e={}){const s=localStorage.getItem("token"),l={"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{},...e.headers},c=await fetch(t,{...e,headers:l});if(c.status===401)throw localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/login",new Error("未授权访问");return c},async get(t,e={}){return this.request(t,{...e,method:"GET"})},async post(t,e,s={}){return this.request(t,{...s,method:"POST",body:JSON.stringify(e)})},async put(t,e,s={}){return this.request(t,{...s,method:"PUT",body:JSON.stringify(e)})},async delete(t,e={}){return this.request(t,{...e,method:"DELETE"})}},f=document.getElementById("version1"),E=document.getElementById("version2"),o=document.getElementById("chapters"),r=document.getElementById("books"),O=T.map(t=>[t.key,t.name]);S(f,Object.entries(q));S(E,Object.entries(q));S(r,O);const L=document.getElementById("content1"),$=document.getElementById("content2");function w(t,e){const s=document.getElementById("message");s&&(s.textContent=t,s.className=`fixed top-4 right-4 p-4 rounded shadow-lg ${e==="success"?"bg-green-500":"bg-red-500"} text-white`,s.classList.remove("hidden"),setTimeout(()=>{s.classList.add("hidden")},3e3))}async function C(t,e){if(e.innerHTML="",f.value==="zyb"&&e===L){const l=await(await fetch(`/api/verses/get?version=${f.value}&book=${r.value}&chapter=${o.value}`)).json();for(const c of l){const g=document.createElement("p"),p=c.refId;g.innerHTML=`${c.verse} <span class="editable" data-verse-id="${p}">${c.content}</span>`;const y=g.querySelector(".editable");y&&(y.contentEditable="false",y.addEventListener("click",N=>{if(!localStorage.getItem("token")){w("请先登录后再编辑","error");return}document.querySelectorAll(".editable").forEach(a=>{a.contentEditable="false";const u=a.nextElementSibling;(u?.classList.contains("confirm-btn")||u?.classList.contains("cancel-btn"))&&u.remove();const m=u?.nextElementSibling;(m?.classList.contains("confirm-btn")||m?.classList.contains("cancel-btn"))&&m.remove()});const n=N.target,b=n.nextElementSibling;(b?.classList.contains("confirm-btn")||b?.classList.contains("cancel-btn"))&&b.remove();const I=b?.nextElementSibling;(I?.classList.contains("confirm-btn")||I?.classList.contains("cancel-btn"))&&I.remove(),n.contentEditable="true",n.focus();const x=n.onblur;n.onblur=null;const i=document.createElement("button");i.className="confirm-btn ml-2 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",i.textContent="确认",console.log("创建确认按钮");const A=async a=>{console.log("确认按钮被点击"),a.preventDefault(),a.stopPropagation();const u=n.dataset.verseId,m=n.textContent;if(console.log("准备更新:",{verseId:u,newText:m}),u&&m)try{console.log("发送更新请求:",{version:f.value,refId:u,content:m});const h=await H.post("/api/verses/update",{version:f.value,refId:u,content:m}),k=await h.json();if(console.log("API响应:",k),!h.ok)throw new Error(k.error||"更新失败");n.onblur=null,c.content=m,w("更新成功","success"),i.remove(),d.remove(),n.contentEditable="false",n.onblur=x}catch(h){console.error("更新失败:",h),w("更新失败："+(h instanceof Error?h.message:"未知错误"),"error"),n.textContent=c.content,i.remove(),d.remove(),n.contentEditable="false",n.onblur=x}};i.onmousedown=A,console.log("确认按钮事件已绑定");const d=document.createElement("button");d.className="cancel-btn ml-2 px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600",d.textContent="取消",console.log("创建取消按钮");const M=a=>{console.log("取消按钮被点击"),a.preventDefault(),a.stopPropagation(),n.onblur=null,n.textContent=c.content,i.remove(),d.remove(),n.contentEditable="false",n.onblur=x};d.onmousedown=M,console.log("取消按钮事件已绑定"),n.onblur=()=>{console.log("经文失去焦点");const a=document.activeElement;a!==i&&a!==d&&(i.remove(),d.remove(),n.contentEditable="false",n.textContent=c.content,n.onblur=x)},n.parentNode?.insertBefore(i,n.nextSibling),n.parentNode?.insertBefore(d,i.nextSibling),console.log("按钮已添加到DOM")})),e.appendChild(g)}}else{const l=await(await fetch(t)).json();for(const c of l){const g=document.createElement("p");g.innerHTML=`${c.num} ${c.verse}`,e.appendChild(g)}}}function D(){const t=document.querySelectorAll("#content1 p"),e=document.querySelectorAll("#content2 p"),s=Math.min(t.length,e.length);for(let l=0;l<s;l++){t[l].style.height="",e[l].style.height="";const c=t[l].offsetHeight,g=e[l].offsetHeight,p=Math.max(c,g);t[l].style.height=p+"px",e[l].style.height=p+"px"}}async function v(){if(L&&$){const t=`/version/${f.value}/${r.value}/${o.value}.json`,e=`/version/${E.value}/${r.value}/${o.value}.json`;await C(t,L),await C(e,$),D()}}function B(){j(o,T.find(t=>t.key===r.value)?.chapters??0),o.selectedIndex=0}f.selectedIndex=0;E.selectedIndex=1;r.selectedIndex=0;B();o.selectedIndex=0;f.addEventListener("change",()=>v());E.addEventListener("change",()=>v());o.addEventListener("change",()=>v());r.addEventListener("change",()=>B());window.addEventListener("DOMContentLoaded",v);document.querySelectorAll(".nextpage").forEach(t=>{console.log("add events"),t.addEventListener("click",()=>{let e=!1;o.selectedIndex<o.options.length-1?(o.selectedIndex=o.selectedIndex+1,e=!0):r.selectedIndex<r.options.length-1&&(o.selectedIndex=0,r.selectedIndex=r.selectedIndex+1,e=!0),e&&(v(),window.scrollTo(0,0))})});document.querySelectorAll(".prepage").forEach(t=>{console.log("add events"),t.addEventListener("click",()=>{let e=!1;o.selectedIndex>0?(o.selectedIndex=o.selectedIndex-1,e=!0):r.selectedIndex>0&&(r.selectedIndex=r.selectedIndex-1,B(),o.selectedIndex=o.options.length-1,e=!0),e&&(window.scrollTo(0,0),v())})});
