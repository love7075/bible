import{b as E,f as I,v as B,a as D}from"./utils.D3Cb6wSv.js";const T={async request(e,n={}){const o=localStorage.getItem("token"),t={"Content-Type":"application/json",...o?{Authorization:`Bearer ${o}`}:{},...n.headers},s=await fetch(e,{...n,headers:t});if(s.status===401)throw localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/login",new Error("未授权访问");return s},async get(e,n={}){return this.request(e,{...n,method:"GET"})},async post(e,n,o={}){return this.request(e,{...o,method:"POST",body:JSON.stringify(n)})},async put(e,n,o={}){return this.request(e,{...o,method:"PUT",body:JSON.stringify(n)})},async delete(e,n={}){return this.request(e,{...n,method:"DELETE"})}},g=document.getElementById("version1"),p=document.getElementById("version2"),c=document.getElementById("chapters"),a=document.getElementById("books"),q=E.map(e=>[e.key,e.name]);I(g,Object.entries(B));I(p,Object.entries(B));I(a,q);const y=document.getElementById("content1"),L=document.getElementById("content2"),x=new Map;async function M(e){if(x.has(e))return x.get(e);const o=await(await fetch(e)).json();return x.set(e,o),o}function v(e,n){const o=document.getElementById("message");o&&(o.textContent=e,o.className=`fixed top-4 right-4 p-4 rounded shadow-lg ${n==="success"?"bg-green-500":"bg-red-500"} text-white`,o.classList.remove("hidden"),setTimeout(()=>{o.classList.add("hidden")},3e3))}function N(e,n){e.contentEditable="false",e.addEventListener("click",o=>{if(!localStorage.getItem("token")){v("请先登录后再编辑","error");return}document.querySelectorAll(".editable").forEach(l=>{l.contentEditable="false";const f=l.nextElementSibling;(f?.classList.contains("confirm-btn")||f?.classList.contains("cancel-btn"))&&f.remove();const m=f?.nextElementSibling;(m?.classList.contains("confirm-btn")||m?.classList.contains("cancel-btn"))&&m.remove()});const t=o.target,s=t.nextElementSibling;(s?.classList.contains("confirm-btn")||s?.classList.contains("cancel-btn"))&&s.remove();const i=s?.nextElementSibling;(i?.classList.contains("confirm-btn")||i?.classList.contains("cancel-btn"))&&i.remove(),t.contentEditable="true",t.focus();const r=t.onblur;t.onblur=null;const d=document.createElement("button");d.className="confirm-btn ml-2 px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",d.textContent="确认",console.log("创建确认按钮");const C=async l=>{console.log("确认按钮被点击"),l.preventDefault(),l.stopPropagation();const f=t.dataset.verseId,m=t.textContent;if(console.log("准备更新:",{verseId:f,newText:m}),f&&m)try{console.log("发送更新请求:",{version:g.value,refId:f,content:m});const h=await T.post("/api/verses/update",{version:g.value,refId:f,content:m}),k=await h.json();if(console.log("API响应:",k),!h.ok)throw new Error(k.error||"更新失败");t.onblur=null,n.content=m,v("更新成功","success"),d.remove(),u.remove(),t.contentEditable="false",t.onblur=r}catch(h){console.error("更新失败:",h),v("更新失败："+(h instanceof Error?h.message:"未知错误"),"error"),t.textContent=n.content,d.remove(),u.remove(),t.contentEditable="false",t.onblur=r}};d.onmousedown=C,console.log("确认按钮事件已绑定");const u=document.createElement("button");u.className="cancel-btn ml-2 px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600",u.textContent="取消",console.log("创建取消按钮");const $=l=>{console.log("取消按钮被点击"),l.preventDefault(),l.stopPropagation(),t.onblur=null,t.textContent=n.content,d.remove(),u.remove(),t.contentEditable="false",t.onblur=r};u.onmousedown=$,console.log("取消按钮事件已绑定"),t.onblur=()=>{console.log("经文失去焦点");const l=document.activeElement;l!==d&&l!==u&&(d.remove(),u.remove(),t.contentEditable="false",t.textContent=n.content,t.onblur=r)},t.parentNode?.insertBefore(d,t.nextSibling),t.parentNode?.insertBefore(u,d.nextSibling),console.log("按钮已添加到DOM")})}async function A(e,n,o,t){return e==="zyb"?await(await fetch(`/api/verses/get?version=${e}&book=${n}&chapter=${o}`)).json():(await M(t)).find(r=>r.book===n&&r.chapter===o)?.verses||[]}function j(e,n,o){const t=document.createElement("p");if(o){const s=e.refId,i=e.content;t.innerHTML=`${e.verse} <span class="editable" data-verse-id="${s}">${i}</span>`;const r=t.querySelector(".editable");r&&N(r,e)}else t.innerHTML=`${e.num} ${e.verse}`;n.appendChild(t)}async function S(e,n){n.innerHTML="";try{const o=n===y?g.value:p.value,t=o==="zyb",s=await A(o,a.value,parseInt(c.value),e);for(const i of s)j(i,n,t)}catch(o){console.error("获取数据时出错:",o)}}function H(){const e=document.querySelectorAll("#content1 p"),n=document.querySelectorAll("#content2 p"),o=Math.min(e.length,n.length);for(let t=0;t<o;t++){e[t].style.height="",n[t].style.height="";const s=e[t].offsetHeight,i=n[t].offsetHeight,r=Math.max(s,i);e[t].style.height=r+"px",n[t].style.height=r+"px"}}async function b(){if(y&&L){const e=E.find(s=>s.key===a.value);if(!e)return;const n=e.chunk||1;parseInt(c.value);const o=`/version/${g.value}/chunk${n}.json`,t=`/version/${p.value}/chunk${n}.json`;await S(o,y),await S(t,L),H()}}function w(){D(c,E.find(e=>e.key===a.value)?.chapters??0),c.selectedIndex=0}g.selectedIndex=0;p.selectedIndex=1;a.selectedIndex=0;w();c.selectedIndex=0;g.addEventListener("change",()=>b());p.addEventListener("change",()=>b());c.addEventListener("change",()=>b());a.addEventListener("change",()=>w());window.addEventListener("DOMContentLoaded",b);document.querySelectorAll(".nextpage").forEach(e=>{console.log("add events"),e.addEventListener("click",()=>{let n=!1;c.selectedIndex<c.options.length-1?(c.selectedIndex=c.selectedIndex+1,n=!0):a.selectedIndex<a.options.length-1&&(c.selectedIndex=0,a.selectedIndex=a.selectedIndex+1,n=!0),n&&(b(),window.scrollTo(0,0))})});document.querySelectorAll(".prepage").forEach(e=>{console.log("add events"),e.addEventListener("click",()=>{let n=!1;c.selectedIndex>0?(c.selectedIndex=c.selectedIndex-1,n=!0):a.selectedIndex>0&&(a.selectedIndex=a.selectedIndex-1,w(),c.selectedIndex=c.options.length-1,n=!0),n&&(window.scrollTo(0,0),b())})});
